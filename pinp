#!/bin/bash
#
# pinp - plays local files and streaming video in a picture-in-picture window
#
# This script requires mpv and youtube-dl
#

PROGRAM=$(basename $0)


# Config file 
USER_CONF="$HOME/.config/pinp/pinp.conf"
SYSTEM_CONF="/etc/pinp/pinp.conf.default"


# Source config from user home if available...
if [[ -f $USER_CONF ]]; then
       . $USER_CONF
else
       #...else source settings from system config
       . $SYSTEM_CONF
fi




play_local()
{
        mpv $mpv_options "$1"
}

stream_url()
{
        mpv $mpv_options --ytdl-format $FORMAT "$1" 
}

stream_search()
{
    mpv $mpv_options $(youtube-dl --format $FORMAT --dateafter $DATE --get-url "$VIDEO_SEARCH$VIDEO_NO:$1") 
}

usage()
{
    printf "\nThis is $PROGRAM. At a minimum, you need to specify a file, search term or URL.\n\n"
    printf "The following options are also available:\n\n\n"
    printf '%-20s%-60s \n' "-n" "queue up n number of streams from search"
    printf '%-20s%-60s \n' "-d" "search for videos uploaded during the last: day, week, month, year"
    printf '%-20s%-60s \n' "-s, -m, -l" "set size of picture-in-picture video (small, medium, large)"
    printf '%-20s%-60s \n\n' "-f" "select the source to search: yt=youtube, gv=google video"
    printf "\n USAGE: $PROGRAM [options] <search or URL to stream>\n\n"
}



# Check for options
while getopts ":n:f:d:sml" OPTION
do
        case $OPTION in

                n) VIDEO_NO=$OPTARG;;
                f) VIDEO_SEARCH="${OPTARG}search";;
                s) SIZE="$SMALL_VID";;
                m) SIZE="$MED_VID";;
                l) SIZE="$LARGE_VID";;
                d) DATE="now-1${OPTARG}";;
                *) usage
                   exit;;

        esac
done


# Shift options along so content is first argument
shift $((OPTIND - 1))


# Exit if no content specified
if [[ $# -eq 0 ]]; then
        usage
        exit
fi

# Set basic options to enable mpv picture-in-picture mode
mpv_options="--ontop --no-border --on-all-workspaces --autofit=$SIZE --geometry=$POSITION"

# Make format more flexible for google video search
if [[ "$SEARCH" -eq "gvsearch" ]]; then
        FORMAT="[height<=?720]"
fi


# Stream content
if [[ "$1" =~ ^"http" ]]; then
        stream_url "$1"
elif [[ -f "$1" ]]; then
        play_local "$1"
else
        stream_search "$1"
fi 
