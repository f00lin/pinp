#!/bin/bash
#
# This script requires mpv and youtube-dl
#

# Playlist file
PLAYLIST="$HOME/.config/pinp/playlist.txt"
# Config file 
PINPCONF="$HOME/.config/pinp/pinp.conf"

# Create config file if does not exist
if [ ! -f $PINPCONF ]; then
       install -D -m644 /etc/pinp/pinp.conf.default $PINPCONF 
fi

# Import settings from config file
. $PINPCONF

# Set basic options to enable mpv picture-in-picture mode
mpv_options="--ontop --no-border --on-all-workspaces --autofit=$SIZE --geometry=$POSITION"


play_local()
{
        mpv $mpv_options "$1"
}

stream_url()
{
        mpv $mpv_options --ytdl-format $FORMAT "$1" 
}

create_playlist()
{
        youtube-dl --dump-json --flat-playlist "$1" | jq -r '.id' | sed 's_^_https://youtube.com/v/_' > $PLAYLIST
        
        stream_url --playlist=$PLAYLIST
}



# Check that only one argument has been passed... 
if [[ $# -gt 1 ]]; then
        echo "pinp only takes one argument: the video or url you want to play."
        exit
else
        # ...and assign that as the source to play
        _content="$1"
fi



if [[ "$_content" =~ ^"http" ]]; then
        stream_url "$_content"
else
        case "$_content" in

                ytsearch*) create_playlist "$_content";; 

                *) play_local "$_content";; 

        esac

fi

