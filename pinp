#!/bin/bash

PROGRAM=$(basename $0)
VERSION=0.3

# Config file 
PINPCONF="$HOME/.config/pinp/pinp.conf"
# Temporary playlist file
PLAYLIST="$HOME/.config/pinp/playlist.txt"

# Create config file if does not exist
if [ ! -f $PINPCONF ]; then
       install -D -m644 /etc/pinp/pinp.conf.default $PINPCONF 
fi

# Import settings from config file
. $PINPCONF


# Check that only one argument has been passed... 
if [ $# -gt 1 ]; then
        echo "pinp only takes one argument, the content to play"
        exit
fi
# ...assign that argument to the source to play...
_url="$1"


# Perform a regex check to find whether source is a file, generic url or youtube

# if content is NOT a link, assume local video file
if [[ ! "$1" =~ ^"http" ]]; then
        _type="local"        
# if it is a link, but NOT from youtube treat as general url to stream
elif [[ "$1" != *"youtube.com"* ]]; then      
        _type="url"
# check if link is for a youtube video
elif [[ "$1" == *"youtube.com/watch"* ]]; then
        _type="yt"
# check if link is to youtube playlist or channel
elif [[ "$1" == *"youtube.com/playlist"* || "$1" == *"youtube.com/channel"* ]]; then
        _type="ytpl"
# otherwise report error and exit
else
        echo "Cannot identify the source."
        exit
       
fi


# Set basic options to enable mpv picture-in-picture mode
mpv_options="--ontop --no-border --on-all-workspaces --autofit=$SIZE --geometry=$POSITION"


play_local()
{
        mpv $mpv_options "$1"

}


stream_url()
{
        mpv $mpv_options --ytdl --ytdl-format "$1" "$2" 
        
}


stream_playlist()
{
        # get playlist URLs and write to temporary file 
        youtube-dl --dump-json --flat-playlist "$1" | jq -r '.id' | sed 's_^_https://youtube.com/v/_' > $PLAYLIST

        # play each of the videos in turn
        while read URL
        do
                stream_url $YT_FORMAT "$URL"
        done < $PLAYLIST

        # clean up playlist file
        rm $PLAYLIST

}



case "$_type" in
                
        # stream youtube video
        yt) stream_url $YT_FORMAT "$_url";;

        # stream youtube playlist
        ytpl) stream_playlist "$_url";;

        # stream provided URL
        url) stream_url $FORMAT "$_url";;

        # stream local file
        local) play_local "$_url";;

        # give error for anything else
        *) echo "Invalid options given.";; 

esac


